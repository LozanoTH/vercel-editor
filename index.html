<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cámara - Control con Gestos</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      overflow-x: hidden;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }
    h1, h3 { 
      text-align: center; 
      margin-bottom: 20px;
      color: #4db8ff;
    }
    .video-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .video-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin-bottom: 15px;
    }
    video, canvas { 
      background:#000; 
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    .fps-counter {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
    }
    .controls { 
      margin-top: 15px; 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    button { 
      padding: 10px 15px; 
      cursor: pointer;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    button:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: translateY(-2px);
    }
    select { 
      padding: 8px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      width: 100%;
      max-width: 300px;
    }
    .camera-selector {
      margin-bottom: 15px;
      text-align: center;
    }
    label {
      display: block;
      margin-bottom: 8px;
    }
    .status {
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
    }
    .gesture-controls {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-top: 20px;
      gap: 20px;
    }
    .control-panel {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
      flex: 1;
    }
    .control-title {
      text-align: center;
      margin-bottom: 10px;
      color: #4db8ff;
      font-weight: bold;
    }
    .value-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      text-align: center;
    }
    .vol-display {
      color: #00ffaa;
    }
    .speed-display {
      color: #ffaa00;
    }
    .vol-bar, .speed-bar {
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      margin-top: 8px;
      overflow: hidden;
    }
    .vol-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ffaa, #4db8ff);
      width: 100%;
      transition: width 0.3s ease;
    }
    .speed-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffaa00, #ff4d4d);
      width: 50%;
      transition: width 0.3s ease;
    }
    .instructions {
      margin-top: 20px;
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .hand-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin: 0 5px;
    }
    .left-hand {
      background: #00ffaa;
    }
    .right-hand {
      background: #ffaa00;
    }
    @media (max-width: 768px) {
      .gesture-controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Control de Cámara con Gestos</h1>

    <div class="camera-selector">
      <label for="cameras">Seleccionar cámara:</label>
      <select id="cameras"></select>
    </div>

    <div class="video-section">
      <div class="video-container">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="output_canvas"></canvas>
        <div class="fps-counter" id="fpsCounter">FPS: --</div>
      </div>

      <div class="controls">
        <button id="startBtn">Iniciar cámara</button>
        <button id="stopBtn">Parar cámara</button>
        <button id="muteBtn">Desactivar video</button>
        <button id="reconnectBtn">Reconectar</button>
      </div>

      <div class="status" id="status">
        Estado: Esperando para iniciar cámara
      </div>
    </div>

    <div class="gesture-controls">
      <div class="control-panel">
        <div class="control-title">
          <span class="hand-indicator left-hand"></span>
          Control de Volumen
        </div>
        <div>Volumen</div>
        <div class="value-display vol-display" id="vol-value">1.00</div>
        <div class="vol-bar"><div class="vol-fill" id="vol-fill"></div></div>
        <p>Usa tu <strong>mano izquierda</strong> - Junta o separa pulgar e índice</p>
      </div>

      <div class="control-panel">
        <div class="control-title">
          <span class="hand-indicator right-hand"></span>
          Control de Velocidad
        </div>
        <div>Velocidad</div>
        <div class="value-display speed-display" id="speed-value">1.00</div>
        <div class="speed-bar"><div class="speed-fill" id="speed-fill"></div></div>
        <p>Usa tu <strong>mano derecha</strong> - Junta o separa pulgar e índice</p>
      </div>
    </div>

    <div class="instructions">
      <h3>Instrucciones</h3>
      <p>Inicia la cámara y muestra tus manos frente a ella para controlar el volumen y velocidad de reproducción.</p>
      <p><span class="hand-indicator left-hand"></span> Mano izquierda controla el VOLUMEN</p>
      <p><span class="hand-indicator right-hand"></span> Mano derecha controla la VELOCIDAD</p>
    </div>
  </div>

  <audio id="music" src="https://audiocdn.epidemicsound.com/lqmp3/01HSGPJ5N6JRK6AV4W8A1ZEEFN.mp3" loop></audio>

  <!-- MediaPipe Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const videoEl = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const muteBtn = document.getElementById('muteBtn');
    const reconnectBtn = document.getElementById('reconnectBtn');
    const camerasSelect = document.getElementById('cameras');
    const statusEl = document.getElementById('status');
    const fpsCounter = document.getElementById('fpsCounter');

    // Elementos de MediaPipe
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    // Elementos de audio y controles
    const music = document.getElementById('music');
    const volValue = document.getElementById('vol-value');
    const speedValue = document.getElementById('speed-value');
    const volFill = document.getElementById('vol-fill');
    const speedFill = document.getElementById('speed-fill');

    // Variables de estado
    let currentStream = null;
    let isMuted = false;
    let frameCount = 0;
    let lastTime = performance.now();
    let fps = 0;

    // Variables para el control de gestos
    let lastVolume = 1.0;
    let lastSpeed = 1.0;
    const smoothFactor = 0.15;
    const volBuffer = [];
    const speedBuffer = [];
    let isPlaying = false;
    let hands = null;
    let camera = null;

    // Contador de FPS
    function updateFPS() {
      frameCount++;
      const currentTime = performance.now();
      if (currentTime - lastTime >= 1000) {
        fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
        frameCount = 0;
        lastTime = currentTime;
        fpsCounter.textContent = `FPS: ${fps}`;
      }
      requestAnimationFrame(updateFPS);
    }
    updateFPS();

    // Actualizar estado
    function updateStatus(message) {
      statusEl.textContent = `Estado: ${message}`;
    }

    // Actualizar la interfaz de usuario de controles
    function updateUI() {
      volValue.textContent = music.volume.toFixed(2);
      speedValue.textContent = music.playbackRate.toFixed(2);
      volFill.style.width = `${music.volume * 100}%`;
      speedFill.style.width = `${(music.playbackRate / 2) * 100}%`;
    }

    // Funciones auxiliares para el control de gestos
    function dist(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    function clamp(v, min, max) {
      return Math.min(Math.max(v, min), max);
    }

    function smoothValue(newVal, lastVal) {
      return lastVal + (newVal - lastVal) * smoothFactor;
    }

    function stableValue(values) {
      const avg = values.reduce((a,b)=>a+b,0) / values.length;
      let closest = values[0];
      let diff = Math.abs(values[0]-avg);
      for(let v of values){
        let d = Math.abs(v-avg);
        if(d < diff) { diff = d; closest = v; }
      }
      return closest;
    }

    // Inicializar MediaPipe Hands
    function initializeMediaPipe() {
      if (hands) {
        hands.close();
        hands = null;
      }

      hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });

      hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 0,
        selfieMode: true,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
      });

      hands.onResults(onResults);

      // Configurar la cámara de MediaPipe
      if (camera) {
        camera.stop();
        camera = null;
      }

      camera = new Camera(videoEl, {
        onFrame: async () => {
          if (hands) {
            await hands.send({image: videoEl});
          }
        },
        width: 640,
        height: 480
      });
      camera.start();

      // Configurar el canvas
      canvasElement.width = videoEl.videoWidth;
      canvasElement.height = videoEl.videoHeight;
    }

    // Procesar resultados de MediaPipe
    function onResults(results) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      
      // Dibujar la imagen del video en el canvas
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
          const landmarks = results.multiHandLandmarks[i];
          const thumb = landmarks[4];  // Punto del pulgar
          const index = landmarks[8];  // Punto del índice
          const d = dist(thumb, index);
          const handLabel = results.multiHandedness[i].label;

          // Dibujar solo los puntos del pulgar e índice
          [thumb, index].forEach(p => {
            canvasCtx.beginPath();
            canvasCtx.arc(p.x * canvasElement.width, p.y * canvasElement.height, 10, 0, Math.PI * 2);
            canvasCtx.fillStyle = handLabel === "Left" ? "#00ffaa" : "#ffaa00";
            canvasCtx.fill();
            canvasCtx.strokeStyle = "white";
            canvasCtx.lineWidth = 2;
            canvasCtx.stroke();
          });

          // Dibujar línea entre pulgar e índice
          canvasCtx.beginPath();
          canvasCtx.moveTo(thumb.x * canvasElement.width, thumb.y * canvasElement.height);
          canvasCtx.lineTo(index.x * canvasElement.width, index.y * canvasElement.height);
          canvasCtx.strokeStyle = handLabel === "Left" ? "#00ffaa" : "#ffaa00";
          canvasCtx.lineWidth = 5;
          canvasCtx.stroke();

          // Control de volumen (mano izquierda)
          if (handLabel === "Left") {
            const normVol = clamp((d - 0.02) / (0.25 - 0.02), 0, 1);
            volBuffer.push(normVol);
            if (volBuffer.length > 5) volBuffer.shift();
            const stableVol = stableValue(volBuffer);
            const smoothVol = smoothValue(stableVol, lastVolume);
            music.volume = smoothVol;
            lastVolume = smoothVol;
          }

          // Control de velocidad (mano derecha)
          if (handLabel === "Right") {
            const normSpeed = clamp((d - 0.02) / (0.25 - 0.02), 0, 2);
            speedBuffer.push(normSpeed);
            if (speedBuffer.length > 5) speedBuffer.shift();
            const stableSpeed = stableValue(speedBuffer);
            const smoothSpeed = smoothValue(stableSpeed, lastSpeed);
            music.playbackRate = smoothSpeed;
            lastSpeed = smoothSpeed;
          }
        }
      }

      updateUI();
      canvasCtx.restore();
    }

    // Listar cámaras disponibles
    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        camerasSelect.innerHTML = '';
        
        if (cams.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = 'No se encontraron cámaras';
          camerasSelect.appendChild(opt);
          return;
        }
        
        cams.forEach((c, i) => {
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.textContent = c.label || `Cámara ${i+1}`;
          camerasSelect.appendChild(opt);
        });
      } catch (e) {
        console.error('No se pudieron listar dispositivos', e);
        updateStatus('Error al listar cámaras');
      }
    }

    // Iniciar cámara con configuración optimizada
    async function startCamera(deviceId) {
      stopStream(); // Asegurar que no haya otro stream activo
      
      // Configuración optimizada para rendimiento
      const constraints = {
        video: deviceId ? { 
          deviceId: { exact: deviceId },
          width: { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 30, max: 60 }
        } : { 
          width: { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 30, max: 60 }
        },
        audio: false
      };
      
      try {
        updateStatus('Iniciando cámara...');
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = currentStream;
        isMuted = false;
        updateMuteButton();
        updateStatus('Cámara activa');
        
        // Inicializar MediaPipe después de que el video esté listo
        videoEl.onloadedmetadata = () => {
          initializeMediaPipe();
          
          // Iniciar reproducción de audio
          if (!isPlaying) {
            music.play().catch(e => console.log("Error al reproducir audio:", e));
            isPlaying = true;
          }
        };
        
      } catch (err) {
        console.error('Error al acceder a la cámara:', err);
        updateStatus('Error al acceder a la cámara');
        
        // Intentar con configuración más básica si falla
        if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
          try {
            updateStatus('Intentando configuración alternativa...');
            const fallbackConstraints = {
              video: deviceId ? { deviceId: { exact: deviceId } } : true,
              audio: false
            };
            currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
            videoEl.srcObject = currentStream;
            isMuted = false;
            updateMuteButton();
            updateStatus('Cámara activa (configuración básica)');
            
            // Inicializar MediaPipe después de que el video esté listo
            videoEl.onloadedmetadata = () => {
              initializeMediaPipe();
              
              // Iniciar reproducción de audio
              if (!isPlaying) {
                music.play().catch(e => console.log("Error al reproducir audio:", e));
                isPlaying = true;
              }
            };
          } catch (fallbackErr) {
            console.error('Error con configuración alternativa:', fallbackErr);
            updateStatus('No se pudo acceder a la cámara');
          }
        }
      }
    }

    // Detener stream
    function stopStream() {
      if (!currentStream) return;
      
      const tracks = currentStream.getTracks();
      tracks.forEach(t => t.stop());
      videoEl.srcObject = null;
      currentStream = null;
      isMuted = false;
      updateMuteButton();
      updateStatus('Cámara detenida');
      
      // Detener MediaPipe
      if (camera) {
        camera.stop();
        camera = null;
      }
      if (hands) {
        hands.close();
        hands = null;
      }
      
      // Limpiar canvas
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    }

    // Alternar estado del video
    function toggleMuteVideo() {
      if (!currentStream) return;
      
      currentStream.getVideoTracks().forEach(track => {
        track.enabled = !track.enabled;
        isMuted = !track.enabled;
      });
      updateMuteButton();
      updateStatus(isMuted ? 'Video desactivado' : 'Video activado');
    }

    // Actualizar texto del botón de mute
    function updateMuteButton() {
      muteBtn.textContent = isMuted ? 'Activar video' : 'Desactivar video';
    }

    // Eventos
    startBtn.addEventListener('click', () => startCamera(camerasSelect.value || undefined));
    stopBtn.addEventListener('click', stopStream);
    muteBtn.addEventListener('click', toggleMuteVideo);
    reconnectBtn.addEventListener('click', () => startCamera(camerasSelect.value || undefined));

    // Cambiar cámara seleccionada
    camerasSelect.addEventListener('change', () => {
      if (currentStream) startCamera(camerasSelect.value);
    });

    // Inicializar lista de cámaras al cargar
    (async () => {
      await listCameras();
      // Si no hay labels (permiso no concedido aún), pide permiso temporal para listar correctamente
      if (camerasSelect.options.length === 0 || camerasSelect.options[0].textContent.includes('No se')) {
        try {
          const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          s.getTracks().forEach(t => t.stop());
          await listCameras();
        } catch (e) {
          // no hacer nada
        }
      }
    })();

    // Al cerrar la pestaña, asegurar que se pare la cámara
    window.addEventListener('beforeunload', stopStream);
    
    // Detectar cambios en dispositivos
    navigator.mediaDevices.addEventListener('devicechange', listCameras);

    // Actualizar UI inicial
    updateUI();
  </script>
</body>
</html>